variables:
  SERVICE_NAME: "nextdealapi"

stages:
  - build
  - deploy

image: google/cloud-sdk:alpine
before_script:
    - gcloud config set project "$GCP_PROJECT_ID"
    - gcloud auth activate-service-account --key-file "$GOOGLE_CLOUD_CREDENTIALS"

build:
    stage: build
    script:
      - gcloud builds submit --tag gcr.io/next-deal-326621/nextdealapi


deploy-dev:
  stage: deploy
  only:
    - main
  script:
    - gcloud run deploy nextdealapi --image gcr.io/next-deal-326621/nextdealapi --region=us-central1 --platform managed --allow-unauthenticated --set-env-vars="JWT_SECRET_KEY=KAH-secret-key-blabla,JWT_SECRET_KEY_EXPIRE=1d,MYSQL_CONNECTION=mysql://nextdealapp:nextdealapp@10.0.0.3:3306/nextdeal_dev" --vpc-connector=next-deal-serverless-vpn
